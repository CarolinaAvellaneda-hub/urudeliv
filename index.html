<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>UruDeliv - FIX FINAL</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        :root { --bg: #0d1117; --card: #161b22; --accent: #58a6ff; --text: #c9d1d9; --uprint: #ff3e3e; }
        body { margin: 0; font-family: sans-serif; background: var(--bg); color: var(--text); padding: 10px; }
        .card { background: var(--card); border: 1px solid #30363d; border-radius: 12px; padding: 15px; margin-bottom: 12px; }
        .btn { width: 100%; padding: 12px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; }
        .btn-uprint { background: var(--uprint); color: white; margin-bottom: 15px; }
        input { width: 100%; padding: 12px; background: #010409; border: 1px solid #30363d; color: white; border-radius: 8px; box-sizing: border-box; margin-bottom: 10px; }
        #map { height: 300px; border-radius: 10px; margin: 15px 0; background: #000; border: 1px solid var(--accent); }
        .stats-box { font-size: 20px; font-weight: bold; text-align: center; color: var(--accent); margin-bottom: 10px; }
        .stop-item { display: flex; justify-content: space-between; padding: 10px; background: #21262d; border-radius: 6px; margin-bottom: 5px; font-size: 14px; }
    </style>
</head>
<body>

    <div class="card">
        <button class="btn btn-uprint" onclick="activarUprint()">üìç FIJAR ORIGEN: uPrint (Colonia 2095)</button>
        <input type="text" id="dest" placeholder="Calle y N√∫mero (Ej: Brandzen 1954)">
        <button class="btn" style="background:#238636; color:white" onclick="agregarParada()">A√ëADIR A RUTA</button>
    </div>

    <div id="res" class="card" style="display:none">
        <div class="stats-box" id="stats"></div>
        <button class="btn" style="background:#8957e5; color:white; margin-bottom:10px" onclick="optimizarRuta()">ü™Ñ OPTIMIZAR ORDEN</button>
        <div id="lista"></div>
        <div id="map"></div>
        <button class="btn" style="background:#33ccff; color:black" onclick="abrirWaze()">NAVEGAR AL SIGUIENTE</button>
        <button class="btn" style="background:none; color:gray; margin-top:10px" onclick="location.reload()">REINICIAR</button>
    </div>

<script>
    // COORDENADAS EXACTAS SEG√öN CATASTRO Y GOOGLE MAPS PARA COLONIA 2095
    // Lat: -34.898625, Lon: -56.173252 (Esquina Colonia y Mart√≠n C. Mart√≠nez)
    const UPRINT_COORDS = { lat: -34.898625, lon: -56.173252 };
    let paradas = [];
    let mapa = null;
    let uprintActivado = false;

    function activarUprint() {
        uprintActivado = true;
        document.querySelector('.btn-uprint').innerText = "‚úÖ ORIGEN FIJADO EN COLONIA 2095";
        document.querySelector('.btn-uprint').style.opacity = "0.7";
    }

    async function agregarParada() {
        const d = document.getElementById('dest').value;
        if(!uprintActivado) return alert("Primero toca el bot√≥n rojo de uPrint");
        if(!d) return alert("Escribe una direcci√≥n");

        const r = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(d + ", Montevideo, Uruguay")}&limit=1`);
        const data = await r.json();

        if(data[0]) {
            paradas.push({ lat: parseFloat(data[0].lat), lon: parseFloat(data[0].lon), n: d.toUpperCase() });
            document.getElementById('dest').value = "";
            render();
        } else {
            alert("No encontr√© esa direcci√≥n. Prueba poner Calle y N√∫mero.");
        }
    }

    function render() {
        document.getElementById('res').style.display = 'block';
        const listaDiv = document.getElementById('lista');
        listaDiv.innerHTML = paradas.map((p, i) => `
            <div class="stop-item">
                <span>${i+1}. ${p.n}</span>
                <button onclick="paradas.splice(${i},1);render()" style="background:none; border:none; color:red; cursor:pointer">‚úñ</button>
            </div>
        `).join('');

        actualizarMapaYStats();
    }

    function actualizarMapaYStats() {
        if(mapa) mapa.remove();
        mapa = L.map('map', {zoomControl: false});
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(mapa);

        let puntos = [[UPRINT_COORDS.lat, UPRINT_COORDS.lon]];
        
        // Marcador Especial para uPrint (C√≠rculo Rojo con Pulso)
        L.circleMarker([UPRINT_COORDS.lat, UPRINT_COORDS.lon], {
            radius: 10, color: 'white', weight: 2, fillColor: '#ff3e3e', fillOpacity: 1
        }).addTo(mapa).bindPopup("uPRINT - ORIGEN");

        // Marcadores de Clientes
        paradas.forEach((p, i) => {
            puntos.push([p.lat, p.lon]);
            L.circleMarker([p.lat, p.lon], {
                radius: 7, color: '#58a6ff', weight: 2, fillColor: '#0d1117', fillOpacity: 1
            }).addTo(mapa).bindTooltip((i+1).toString(), {permanent: true, direction: 'center', className: 'label-map'});
        });

        // Dibujar L√≠nea de Trayecto
        if(puntos.length > 1) {
            L.polyline(puntos, {color: '#58a6ff', weight: 3, dashArray: '10, 10', opacity: 0.5}).addTo(mapa);
            mapa.fitBounds(puntos, {padding: [50, 50]});
        }

        // C√°lculo de Distancia y Precio
        let dTotal = 0;
        let pRef = UPRINT_COORDS;
        paradas.forEach(p => {
            dTotal += calcularH(pRef, p);
            pRef = p;
        });

        const distCorregida = (dTotal * 1.3).toFixed(1); // 30% extra por calles reales
        const precio = Math.round(90 + (distCorregida * 14));
        document.getElementById('stats').innerText = `${distCorregida} km | $${precio}`;
    }

    function calcularH(p1, p2) {
        const R = 6371;
        const dLat = (p2.lat - p1.lat) * Math.PI/180;
        const dLon = (p2.lon - p1.lon) * Math.PI/180;
        const a = Math.sin(dLat/2)**2 + Math.cos(p1.lat*Math.PI/180)*Math.cos(p2.lat*Math.PI/180)*Math.sin(dLon/2)**2;
        return R * 2 * Math.asin(Math.sqrt(a));
    }

    function optimizarRuta() {
        let opt = [];
        let copia = [...paradas];
        let actual = UPRINT_COORDS;
        while(copia.length > 0) {
            let cercanoIdx = 0; let minDist = Infinity;
            copia.forEach((p, i) => {
                let d = calcularH(actual, p);
                if(d < minDist) { minDist = d; cercanoIdx = i; }
            });
            actual = copia[cercanoIdx];
            opt.push(copia.splice(cercanoIdx, 1)[0]);
        }
        paradas = opt;
        render();
    }

    function abrirWaze() {
        if(paradas.length === 0) return alert("No hay entregas pendientes");
        const prox = paradas[0];
        window.open(`https://www.waze.com/ul?ll=${prox.lat},${prox.lon}&navigate=yes`);
    }
</script>
<style>
    .label-map { background: transparent; border: none; color: white; font-weight: bold; font-size: 12px; box-shadow: none; }
</style>
</body>
</html>



