<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>UruDeliv Pro - Mapbox Edition</title>
    
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css' rel='stylesheet' />

    <style>
        :root { --bg: #0d1117; --card: #161b22; --accent: #58a6ff; --text: #c9d1d9; --uprint: #ff3e3e; }
        body { margin: 0; font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); padding: 10px; }
        
        .card { background: var(--card); border: 1px solid #30363d; border-radius: 12px; padding: 15px; margin-bottom: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        
        .btn { width: 100%; padding: 14px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; font-size: 14px; transition: 0.2s; margin-bottom: 8px; }
        .btn-uprint { background: var(--uprint); color: white; border: 2px solid rgba(255,255,255,0.2); }
        .btn-add { background: #238636; color: white; }
        .btn-opt { background: #8957e5; color: white; }
        
        input { width: 100%; padding: 14px; background: #010409; border: 1px solid #30363d; color: white; border-radius: 8px; box-sizing: border-box; margin-bottom: 10px; font-size: 16px; }
        
        #map { height: 350px; border-radius: 12px; border: 1px solid #30363d; margin: 10px 0; background: #000; }
        
        .stats-display { text-align: center; margin-bottom: 15px; }
        .stats-km { font-size: 28px; font-weight: bold; color: var(--accent); display: block; }
        .stats-price { font-size: 22px; color: #7ee787; }
        
        .stop-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #21262d; border-radius: 6px; margin-bottom: 6px; border-left: 4px solid var(--accent); }
        .btn-del { background: none; border: none; color: #f85149; font-size: 18px; cursor: pointer; }
        
        .label-marker { background: #58a6ff; color: black; padding: 2px 6px; border-radius: 4px; font-weight: bold; font-size: 12px; }
    </style>
</head>
<body>

    <div class="card">
        <button class="btn btn-uprint" id="btnStatus" onclick="iniciarSistema()">üìç ACTIVAR ORIGEN: uPrint (Colonia 2095)</button>
        <div id="controls" style="display:none">
            <input type="text" id="dest" placeholder="Direcci√≥n de entrega (Ej: Brandzen 1954)">
            <button class="btn btn-add" onclick="buscarDireccion()">+ A√ëADIR A LA HOJA DE RUTA</button>
        </div>
    </div>

    <div id="panel-ruta" class="card" style="display:none">
        <div class="stats-display">
            <span class="stats-km" id="km-text">0.0 KM</span>
            <span class="stats-price" id="price-text">$0</span>
        </div>
        
        <button class="btn btn-opt" onclick="optimizarRuta()">ü™Ñ OPTIMIZAR ORDEN L√ìGICO</button>
        
        <div id="lista-paradas" style="max-height: 150px; overflow-y: auto; margin-bottom: 10px;"></div>
        
        <div id="map"></div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
            <button class="btn" style="background: #33ccff; color: black;" onclick="abrirWaze()">SIGUIENTE (WAZE)</button>
            <button class="btn" style="background: #30363d; color: white;" onclick="location.reload()">BORRAR TODO</button>
        </div>
    </div>

<script>
    // CONFIGURACI√ìN PROFESIONAL
    const ACCESS_TOKEN = 'pk.eyJ1IjoiY2Fyb2F2ZWxsYW5lZGEiLCJhIjoiY21reXdwZTB0MGJzYjNnb2RqbW43aGRkMSJ9.dDPdLqd-z3xBN7D_rW_-nA'; // <--- PEGA TU TOKEN AQU√ç
    mapboxgl.accessToken = ACCESS_TOKEN;

    // Coordenadas Exactas uPrint: [Longitud, Latitud]
    const UPRINT_LOCATION = [-56.173252, -34.898625]; 
    
    let map;
    let paradas = [];
    let markers = [];

    function iniciarSistema() {
        document.getElementById('btnStatus').style.display = 'none';
        document.getElementById('controls').style.display = 'block';
        
        map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/dark-v11',
            center: UPRINT_LOCATION,
            zoom: 15,
            pitch: 45
        });

        // Marcador fijo de uPrint
        new mapboxgl.Marker({ color: '#ff3e3e', scale: 1.2 })
            .setLngLat(UPRINT_LOCATION)
            .setPopup(new mapboxgl.Popup().setHTML("<b>uPrint</b><br>Colonia 2095"))
            .addTo(map);
            
        document.getElementById('panel-ruta').style.display = 'block';
    }

    async function buscarDireccion() {
        const query = document.getElementById('dest').value.trim();
        if (!query) return;

        const url = `https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(query + ", Montevideo, Uruguay")}.json?access_token=${ACCESS_TOKEN}&limit=1`;
        
        try {
            const resp = await fetch(url);
            const data = await resp.json();

            if (data.features && data.features.length > 0) {
                const f = data.features[0];
                paradas.push({
                    id: Date.now(),
                    nombre: query.toUpperCase(),
                    coords: f.center // [long, lat]
                });
                document.getElementById('dest').value = "";
                actualizarInterfaz();
            } else {
                alert("No se encontr√≥ la direcci√≥n exacta.");
            }
        } catch (e) {
            alert("Error al conectar con Mapbox.");
        }
    }

    async function actualizarInterfaz() {
        renderLista();
        limpiarMarcadores();
        
        if (paradas.length === 0) {
            if (map.getLayer('route')) map.removeLayer('route');
            if (map.getSource('route')) map.removeSource('route');
            document.getElementById('km-text').innerText = "0.0 KM";
            document.getElementById('price-text').innerText = "$0";
            return;
        }

        // Trazar Ruta Real por Calles
        const puntosParaRuta = [UPRINT_LOCATION, ...paradas.map(p => p.coords)];
        const coordString = puntosParaRuta.map(c => c.join(',')).join(';');
        
        const routeResp = await fetch(`https://api.mapbox.com/directions/v5/mapbox/driving/${coordString}?geometries=geojson&access_token=${ACCESS_TOKEN}`);
        const routeData = await routeResp.json();

        if (routeData.routes && routeData.routes[0]) {
            const data = routeData.routes[0];
            const distKm = (data.distance / 1000).toFixed(1);
            const precio = Math.round(90 + (distKm * 14));

            document.getElementById('km-text').innerText = `${distKm} KM`;
            document.getElementById('price-text').innerText = `$${precio}`;

            dibujarRuta(data.geometry);
            
            // Ajustar vista
            const bounds = new mapboxgl.LngLatBounds();
            puntosParaRuta.forEach(p => bounds.extend(p));
            map.fitBounds(bounds, { padding: 60 });
        }

        // A√±adir Marcadores de Clientes
        paradas.forEach((p, i) => {
            const m = new mapboxgl.Marker({ color: '#58a6ff' })
                .setLngLat(p.coords)
                .addTo(map);
            markers.push(m);
        });
    }

    function dibujarRuta(geojson) {
        if (map.getSource('route')) {
            map.getSource('route').setData(geojson);
        } else {
            map.addSource('route', { type: 'geojson', data: geojson });
            map.addLayer({
                id: 'route',
                type: 'line',
                source: 'route',
                layout: { 'line-join': 'round', 'line-cap': 'round' },
                paint: { 'line-color': '#58a6ff', 'line-width': 5, 'line-opacity': 0.7 }
            });
        }
    }

    function renderLista() {
        const lista = document.getElementById('lista-paradas');
        lista.innerHTML = paradas.map((p, i) => `
            <div class="stop-item">
                <span><b>${i+1}.</b> ${p.nombre}</span>
                <button class="btn-del" onclick="eliminarParada(${p.id})">‚úï</button>
            </div>
        `).join('');
    }

    function eliminarParada(id) {
        paradas = paradas.filter(p => p.id !== id);
        actualizarInterfaz();
    }

    function limpiarMarcadores() {
        markers.forEach(m => m.remove());
        markers = [];
    }

    function optimizarRuta() {
        if (paradas.length < 2) return;
        let opt = [];
        let copia = [...paradas];
        let actual = UPRINT_LOCATION;

        while (copia.length > 0) {
            let cercanoIdx = 0;
            let minDist = Infinity;
            copia.forEach((p, i) => {
                let d = Math.sqrt(Math.pow(actual[0]-p.coords[0], 2) + Math.pow(actual[1]-p.coords[1], 2));
                if (d < minDist) { minDist = d; cercanoIdx = i; }
            });
            actual = copia[cercanoIdx].coords;
            opt.push(copia.splice(cercanoIdx, 1)[0]);
        }
        paradas = opt;
        actualizarInterfaz();
    }

    function abrirWaze() {
        if (paradas.length === 0) return;
        const p = paradas[0].coords;
        window.open(`https://www.waze.com/ul?ll=${p[1]},${p[0]}&navigate=yes`);
    }
</script>
</body>
</html>





