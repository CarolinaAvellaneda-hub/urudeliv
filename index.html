<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>UruDeliv Pro - GPS Master</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        :root { --bg: #05070a; --card: #12151c; --accent: #2979ff; --text: #f0f2f5; --dim: #8b949e; --nav-h: 85px; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; font-family: sans-serif; background: var(--bg); color: var(--text); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        .header { padding: 15px 20px; font-size: 20px; font-weight: 800; background: var(--card); border-bottom: 1px solid #21262d; flex-shrink: 0; }
        .main-container { flex: 1; position: relative; overflow-y: auto; padding-bottom: var(--nav-h); }
        .view { display: none; height: 100%; padding: 20px; }
        .view.active { display: block; }
        
        /* Ajuste especial para el Mapa */
        #v-mapa { padding: 0; position: relative; }
        #map { height: 100%; width: 100%; z-index: 1; }

        .card { background: var(--card); border-radius: 16px; padding: 20px; border: 1px solid #21262d; margin-bottom: 20px; }
        input { width: 100%; padding: 16px; background: #0d1117; border: 1px solid #30363d; border-radius: 12px; color: white; font-size: 16px; margin-bottom: 10px; }
        .btn-blue { width: 100%; padding: 16px; background: var(--accent); color: white; border: none; border-radius: 12px; font-weight: bold; font-size: 16px; }
        
        /* Navegaci√≥n */
        .nav-bar { position: fixed; bottom: 0; left: 0; right: 0; height: var(--nav-h); background: var(--card); display: flex; border-top: 1px solid #21262d; padding-bottom: env(safe-area-inset-bottom); z-index: 1000; }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--dim); font-size: 11px; }
        .nav-item.active { color: var(--accent); font-weight: bold; }
        .nav-icon { font-size: 24px; margin-bottom: 2px; }

        .pedido-item { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #21262d; }
    </style>
</head>
<body>

<div class="header">UruDeliv <span style="color:var(--accent)">PRO</span></div>

<div class="main-container">
    <div id="v-pedidos" class="view active">
        <div class="card">
            <h3>üìç Nuevo Reparto</h3>
            <input type="text" id="store" placeholder="Nombre de la Tienda">
            <input type="text" id="client" placeholder="Direcci√≥n del Cliente">
            <button class="btn-blue" onclick="iniciarViaje()">INICIAR RUTA (WAZE)</button>
        </div>
        <div id="active-trip" class="card" style="display:none; border-left: 5px solid #4ade80;">
            <p id="trip-info" style="font-weight:bold;"></p>
            <button class="btn-blue" style="background:#238636" onclick="entregado()">FINALIZAR ENTREGA</button>
        </div>
    </div>

    <div id="v-mapa" class="view">
        <div id="map"></div>
    </div>

    <div id="v-balance" class="view">
        <div class="card"><div style="height:150px"><canvas id="chart"></canvas></div></div>
        <div class="card"><h3>Historial</h3><div id="historial"></div></div>
    </div>
</div>

<div class="nav-bar">
    <div class="nav-item active" id="n-pedidos" onclick="show('pedidos')"><span class="nav-icon">üìã</span>Pedidos</div>
    <div class="nav-item" id="n-mapa" onclick="show('mapa')"><span class="nav-icon">üìç</span>Mapa</div>
    <div class="nav-item" id="n-balance" onclick="show('balance')"><span class="nav-icon">üìä</span>Balance</div>
</div>

<script>
    let db = JSON.parse(localStorage.getItem('uru_v3')) || [];
    let map, userMarker, storeMarker, clientMarker;
    let currentTrip = null;

    function show(v) {
        document.querySelectorAll('.view, .nav-item').forEach(e => e.classList.remove('active'));
        document.getElementById('v-'+v).classList.add('active');
        document.getElementById('n-'+v).classList.add('active');
        if(v === 'mapa') initMap();
        if(v === 'balance') renderBalance();
    }

    function initMap() {
        if (!map) {
            map = L.map('map').setView([-34.9011, -56.1645], 13); // Montevideo
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);
        }
        
        navigator.geolocation.watchPosition(p => {
            const pos = [p.coords.latitude, p.coords.longitude];
            if (!userMarker) userMarker = L.circleMarker(pos, {color: '#2979ff', fillOpacity: 1, radius: 8}).addTo(map);
            else userMarker.setLatLng(pos);
            if (!currentTrip) map.panTo(pos);
        });
    }

    async function iniciarViaje() {
        const s = document.getElementById('store').value;
        const c = document.getElementById('client').value;
        if (!s || !c) return alert("Completa los datos");

        // Simulaci√≥n de geocodificaci√≥n (En una app real usar√≠as una API de b√∫squeda)
        // Por ahora, pondremos puntos aleatorios cerca de tu posici√≥n para mostrar en el mapa
        navigator.geolocation.getCurrentPosition(p => {
            const lat = p.coords.latitude;
            const lon = p.coords.longitude;
            
            currentTrip = {
                store: s, client: c, 
                startPos: [lat, lon],
                storePos: [lat + 0.005, lon + 0.005], // Simulado
                clientPos: [lat + 0.01, lon - 0.005]  // Simulado
            };

            if(storeMarker) map.removeLayer(storeMarker);
            if(clientMarker) map.removeLayer(clientMarker);

            storeMarker = L.marker(currentTrip.storePos).addTo(map).bindPopup("Tienda: " + s).openPopup();
            clientMarker = L.marker(currentTrip.clientPos).addTo(map).bindPopup("Cliente: " + c);
            
            document.getElementById('trip-info').innerText = `De: ${s} ‚ûî Para: ${c}`;
            document.getElementById('active-trip').style.display = 'block';
            
            window.open(`https://waze.com/ul?q=${encodeURIComponent(c)}&navigate=yes`);
            show('mapa');
            map.fitBounds([currentTrip.storePos, currentTrip.clientPos, [lat, lon]]);
        });
    }

    function entregado() {
        const km = (Math.random() * 4 + 1).toFixed(1); // Aqu√≠ calculas distancia real como antes
        db.unshift({
            name: currentTrip.client,
            km: km,
            total: (85 + (km * 7.5)).toFixed(0),
            dia: new Date().toLocaleDateString('es-ES', {weekday: 'short'})
        });
        localStorage.setItem('uru_v3', JSON.stringify(db));
        currentTrip = null;
        document.getElementById('active-trip').style.display = 'none';
        alert("¬°Entrega completada!");
        show('balance');
    }

    function renderBalance() {
        const h = document.getElementById('historial');
        h.innerHTML = db.slice(0,5).map(p => `<div class="pedido-item"><span>${p.name}</span><b>$${p.total}</b></div>`).join('');
    }
</script>
</body>
</html>
