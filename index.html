<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>UruDeliv Pro v3.3</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        :root { --bg: #05070a; --card: #12151c; --accent: #2979ff; --text: #f0f2f5; --dim: #8b949e; --nav-h: 85px; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; font-family: sans-serif; background: var(--bg); color: var(--text); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        .header { padding: 15px 20px; font-size: 20px; font-weight: 800; background: var(--card); border-bottom: 1px solid #21262d; flex-shrink: 0; }
        .main-container { flex: 1; position: relative; overflow: hidden; }
        .view { display: none; height: 100%; width: 100%; padding: 20px; overflow-y: auto; padding-bottom: var(--nav-h); }
        .view.active { display: block; }
        #v-mapa { padding: 0; }
        #map { height: 100%; width: 100%; background: var(--bg); }
        .card { background: var(--card); border-radius: 16px; padding: 20px; border: 1px solid #21262d; margin-bottom: 20px; }
        h3 { margin-top: 0; font-size: 11px; text-transform: uppercase; color: var(--dim); letter-spacing: 1px; }
        input { width: 100%; padding: 16px; background: #0d1117; border: 1px solid #30363d; border-radius: 12px; color: white; font-size: 16px; margin-bottom: 10px; outline: none; }
        .btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .btn { width: 100%; padding: 16px; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn-blue { background: var(--accent); color: white; }
        .btn-orange { background: #ff9800; color: white; }
        .btn-green { background: #238636; color: white; }
        .btn-finish { background: #f44336; color: white; width: 100%; }
        .nav-bar { position: fixed; bottom: 0; left: 0; right: 0; height: var(--nav-h); background: var(--card); display: flex; border-top: 1px solid #21262d; padding-bottom: env(safe-area-inset-bottom); z-index: 1000; }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--dim); font-size: 11px; }
        .nav-item.active { color: var(--accent); font-weight: bold; }
        .nav-icon { font-size: 24px; margin-bottom: 2px; }
        .loading-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 2000; color: white; align-items: center; justify-content: center; }
    </style>
</head>
<body>

<div id="loader" class="loading-overlay">Buscando direcciones precisas...</div>
<div class="header">UruDeliv <span style="color:var(--accent)">PRO</span></div>

<div class="main-container">
    <div id="v-pedidos" class="view active">
        <div class="card">
            <h3> Nuevo Reparto</h3>
            <input type="text" id="store" placeholder="Local de Retiro (Ej: Uprint)">
            <input type="text" id="client" placeholder="Destino (Ej: Ceibal 1587)">
            <button class="btn btn-blue" onclick="iniciarViajeReal()">CARGAR RUTA REAL</button>
        </div>
        <div id="active-trip" class="card" style="display:none; border-left: 5px solid #4ade80;">
            <p id="trip-info" style="font-weight:bold; margin-top:0; color: #4ade80;"></p>
            <div class="btn-group">
                <button class="btn btn-orange" onclick="irA('store')"> WAZE RETIRO</button>
                <button class="btn btn-green" onclick="irA('client')"> WAZE ENTREGA</button>
            </div>
            <button class="btn btn-finish" onclick="entregado()">FINALIZAR ENTREGA</button>
        </div>
    </div>
    <div id="v-mapa" class="view"><div id="map"></div></div>
    <div id="v-balance" class="view">
        <div class="card"><div style="height:150px"><canvas id="chart"></canvas></div></div>
        <div class="card"><h3>Historial</h3><div id="historial"></div></div>
    </div>
</div>

<div class="nav-bar">
    <div class="nav-item active" id="n-pedidos" onclick="show('pedidos')"><span class="nav-icon"></span>Pedidos</div>
    <div class="nav-item" id="n-mapa" onclick="show('mapa')"><span class="nav-icon"></span>Mapa</div>
    <div id="n-balance" class="nav-item" onclick="show('balance')"><span class="nav-icon"></span>Balance</div>
</div>

<script>
    // 1. Coordenadas fijas para evitar errores de b煤squeda
    const UBICACIONES_FIJAS = {
        "uprint": [-34.9051, -56.1831], // Colonia y Tacuaremb贸
        "uprint colonia": [-34.9051, -56.1831]
    };

    // 2. Funci贸n matem谩tica para distancia real (Sin margen de error)
    function calcularDistanciaReal(pos1, pos2) {
        const R = 6371; // Radio de la Tierra en km
        const dLat = (pos2[0] - pos1[0]) * Math.PI / 180;
        const dLon = (pos2[1] - pos1[1]) * Math.PI / 180;
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                  Math.cos(pos1[0] * Math.PI / 180) * Math.cos(pos2[0] * Math.PI / 180) *
                  Math.sin(dLon/2) * Math.sin(dLon/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c; 
    }

    async function iniciarViajeReal() {
        const storeInput = document.getElementById('store').value.toLowerCase().trim();
        const clientAddr = document.getElementById('client').value;
        
        document.getElementById('loader').style.display = 'flex';

        // Si es Uprint, usamos la coordenada exacta, si no, buscamos en el mapa
        let posTienda = UBICACIONES_FIJAS[storeInput] || await buscarDireccion(storeInput);
        let posCliente = await buscarDireccion(clientAddr);

        document.getElementById('loader').style.display = 'none';

        if (!posTienda || !posCliente) {
            alert("Direcci贸n no encontrada. Intenta ser m谩s espec铆fico.");
            return;
        }

        // Calculamos la distancia exacta una sola vez
        const distanciaKM = calcularDistanciaReal(posTienda, posCliente).toFixed(2);
        
        currentTrip = {
            store: storeInput.toUpperCase(),
            client: clientAddr,
            storePos: posTienda,
            clientPos: posCliente,
            km: distanciaKM,
            // F贸rmula fija: $85 base + $15 por km (ajusta a tu tarifa)
            total: (85 + (distanciaKM * 15)).toFixed(0) 
        };

        actualizarInterfazViaje();
    }

    function entregado() {
        // Ahora guardamos los datos REALES calculados al inicio
        db.unshift({
            name: currentTrip.client,
            km: currentTrip.km,
            total: currentTrip.total,
            dia: new Date().toLocaleDateString('es-ES', {weekday: 'short'})
        });
        
        localStorage.setItem('uru_v3_3', JSON.stringify(db));
        // ... resto del c贸digo para limpiar interfaz
    }
</script>
</body>
</html>


