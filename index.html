<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>UruDeliv Mapbox Pro</title>
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css' rel='stylesheet' />
    <style>
        :root { --bg: #0d1117; --card: #161b22; --accent: #58a6ff; --text: #c9d1d9; }
        body { margin: 0; font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); padding: 10px; }
        .card { background: var(--card); border: 1px solid #30363d; border-radius: 12px; padding: 15px; margin-bottom: 10px; }
        .btn { width: 100%; padding: 12px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; font-size: 14px; margin-bottom: 8px; }
        .btn-uprint { background: #ff3e3e; color: white; }
        .btn-add { background: #238636; color: white; }
        input { width: 100%; padding: 12px; background: #010409; border: 1px solid #30363d; color: white; border-radius: 8px; box-sizing: border-box; margin-bottom: 10px; }
        #map { height: 350px; border-radius: 12px; border: 1px solid #30363d; }
        .stats { font-size: 22px; text-align: center; color: var(--accent); font-weight: bold; margin: 10px 0; }
        .stop-item { display: flex; justify-content: space-between; padding: 8px; background: #21262d; border-radius: 6px; margin-bottom: 5px; font-size: 13px; }
    </style>
</head>
<body>

    <div class="card">
        <button class="btn btn-uprint" id="btnUprint" onclick="activarUprint()">üìç ACTIVAR UPRINT (COLONIA 2095)</button>
        <input type="text" id="dest" placeholder="Direcci√≥n (Ej: Av Italia 1234)">
        <button class="btn btn-add" onclick="agregarParada()">A√ëADIR ENTREGA</button>
    </div>

    <div id="res" class="card" style="display:none">
        <div class="stats" id="stats">0 km | $0</div>
        <button class="btn" style="background:#8957e5; color:white" onclick="optimizarRuta()">ü™Ñ OPTIMIZAR ORDEN</button>
        <div id="lista" style="margin-bottom:10px"></div>
        <div id="map"></div>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px">
            <button class="btn" style="background:#33ccff; color:black" onclick="abrirWaze()">WAZE</button>
            <button class="btn" style="background:#444; color:white" onclick="location.reload()">REINICIAR</button>
        </div>
    </div>

<script>
    // PEGA TU ACCESS TOKEN AQU√ç
    const ACCESS_TOKEN = 'pk.eyJ1IjoiY2Fyb2F2ZWxsYW5lZGEiLCJhIjoiY21reXdwZTB0MGJzYjNnb2RqbW43aGRkMSJ9.dDPdLqd-z3xBN7D_rW_-nA'; 
    mapboxgl.accessToken = ACCESS_TOKEN;

   const UPRINT_COORDS = [-56.173250, -34.898620]; // Long, Lat para Mapbox
    let paradas = [];
    let map, routeLayer;

    function activarUprint() {
        document.getElementById('btnUprint').innerText = "‚úÖ ORIGEN: COLONIA 2095";
        document.getElementById('btnUprint').style.opacity = "0.6";
        inicializarMapa();
    }

    function inicializarMapa() {
        if (map) return;
        map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/dark-v11',
            center: UPRINT_COORDS,
            zoom: 14
        });

        new mapboxgl.Marker({ color: '#ff3e3e' }).setLngLat(UPRINT_COORDS).addTo(map);
    }

    async function agregarParada() {
        const d = document.getElementById('dest').value;
        if (!map) return alert("Activa uPrint primero");
        
        const r = await fetch(`https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(d + ", Montevideo, Uruguay")}.json?access_token=${ACCESS_TOKEN}&limit=1`);
        const data = await r.json();

        if (data.features && data.features.length > 0) {
            const feat = data.features[0];
            paradas.push({
                lon: feat.center[0],
                lat: feat.center[1],
                n: d.toUpperCase()
            });
            document.getElementById('dest').value = "";
            render();
        } else {
            alert("Direcci√≥n no encontrada");
        }
    }

    async function render() {
        document.getElementById('res').style.display = 'block';
        const listaDiv = document.getElementById('lista');
        listaDiv.innerHTML = paradas.map((p, i) => `
            <div class="stop-item">
                <span>${i+1}. ${p.n}</span>
                <button onclick="paradas.splice(${i},1);render()" style="background:none; border:none; color:red">‚úñ</button>
            </div>
        `).join('');

        actualizarRutaReal();
    }

    async function actualizarRutaReal() {
        if (paradas.length === 0) return;

        const coords = [UPRINT_COORDS, ...paradas.map(p => [p.lon, p.lat])].map(c => c.join(',')).join(';');
        
        const query = await fetch(`https://api.mapbox.com/directions/v5/mapbox/driving/${coords}?geometries=geojson&access_token=${ACCESS_TOKEN}`);
        const response = await query.json();
        
        if (response.routes && response.routes[0]) {
            const data = response.routes[0];
            const distKm = (data.distance / 1000).toFixed(1);
            const precio = Math.round(90 + (distKm * 14));
            
            document.getElementById('stats').innerText = `${distKm} km | $${precio}`;
            dibujarLinea(data.geometry);
        }
    }

    function dibujarLinea(geojson) {
        if (map.getSource('route')) {
            map.getSource('route').setData(geojson);
        } else {
            map.addLayer({
                id: 'route',
                type: 'line',
                source: { type: 'geojson', data: geojson },
                paint: { 'line-color': '#58a6ff', 'line-width': 4, 'line-opacity': 0.8 }
            });
        }
        
        // Ajustar zoom para ver toda la ruta
        const bounds = new mapboxgl.LngLatBounds();
        [UPRINT_COORDS, ...paradas.map(p => [p.lon, p.lat])].forEach(c => bounds.extend(c));
        map.fitBounds(bounds, { padding: 50 });
    }

    // El mismo algoritmo voraz pero ahora actualiza Mapbox
    function optimizarRuta() {
        if (paradas.length < 2) return;
        let opt = [];
        let copia = [...paradas];
        let actual = { lon: UPRINT_COORDS[0], lat: UPRINT_COORDS[1] };

        while (copia.length > 0) {
            let cercanoIdx = 0;
            let minDist = Infinity;
            copia.forEach((p, i) => {
                let d = Math.sqrt((actual.lon-p.lon)**2 + (actual.lat-p.lat)**2);
                if (d < minDist) { minDist = d; cercanoIdx = i; }
            });
            actual = copia[cercanoIdx];
            opt.push(copia.splice(cercanoIdx, 1)[0]);
        }
        paradas = opt;
        render();
    }

    function abrirWaze() {
        if (paradas.length === 0) return;
        const p = paradas[0];
        window.open(`https://www.waze.com/ul?ll=${p.lat},${p.lon}&navigate=yes`);
    }
</script>
</body>
</html>





