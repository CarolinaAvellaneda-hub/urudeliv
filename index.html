<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>UruDeliv Pro - Fix B√∫squeda</title>
    
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css' rel='stylesheet' />

    <style>
        :root { --bg: #0d1117; --card: #161b22; --accent: #58a6ff; --text: #c9d1d9; }
        body { margin: 0; font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); padding: 10px; }
        .card { background: var(--card); border: 1px solid #30363d; border-radius: 12px; padding: 15px; margin-bottom: 10px; }
        .btn { width: 100%; padding: 14px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; font-size: 14px; margin-bottom: 8px; }
        input { width: 100%; padding: 14px; background: #010409; border: 1px solid #30363d; color: white; border-radius: 8px; box-sizing: border-box; margin-bottom: 10px; font-size: 16px; }
        #map { height: 350px; border-radius: 12px; border: 1px solid #30363d; background: #000; margin-top: 10px; }
        .stats { text-align: center; margin-bottom: 10px; }
        .km { font-size: 24px; font-weight: bold; color: var(--accent); }
        .stop-item { display: flex; justify-content: space-between; padding: 10px; background: #21262d; border-radius: 6px; margin-bottom: 6px; font-size: 13px; border-left: 3px solid var(--accent); }
    </style>
</head>
<body>

    <div class="card">
        <h3 style="margin:0 0 10px 0; color:#ff3e3e; font-size: 14px;">üìç ORIGEN: COLONIA 2095</h3>
        <input type="text" id="dest" placeholder="Direcci√≥n de entrega (Ej: Ejido 1234)">
        <button id="btn-add" class="btn" style="background: #238636; color: white;" onclick="buscarDireccion()">+ A√ëADIR ENTREGA</button>
    </div>

    <div id="panel-ruta" class="card">
        <div class="stats" id="stats-container" style="display:none">
            <div class="km" id="km-text">0.0 KM</div>
            <div style="color:#7ee787; font-size: 18px;" id="price-text">$0</div>
            <button class="btn" style="background:#8957e5; color:white; margin-top:10px" onclick="optimizarRuta()">ü™Ñ OPTIMIZAR ORDEN</button>
        </div>
        
        <div id="lista-paradas"></div>
        <div id="map"></div>

        <div id="nav-btns" style="display: none; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
            <button class="btn" style="background: #33ccff; color: black;" onclick="abrirWaze()">WAZE</button>
            <button class="btn" style="background: #30363d; color: white;" onclick="location.reload()">REINICIAR</button>
        </div>
    </div>

<script>
    // PEGA TU TOKEN AQU√ç
    const ACCESS_TOKEN = 'pk.eyJ1IjoiY2Fyb2F2ZWxsYW5lZGEiLCJhIjoiY21reXdwZTB0MGJzYjNnb2RqbW43aGRkMSJ9.dDPdLqd-z3xBN7D_rW_-nA'; 
    mapboxgl.accessToken = ACCESS_TOKEN;

    const UPRINT_LOCATION = [-56.1707247, -34.8985649]; 
    let map, paradas = [], markers = [];

    // Inicializaci√≥n inmediata al cargar el script
    function init() {
        map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/dark-v11',
            center: UPRINT_LOCATION,
            zoom: 16
        });

        // Marcador de uPrint siempre visible
        new mapboxgl.Marker({ color: '#ff3e3e' })
            .setLngLat(UPRINT_LOCATION)
            .addTo(map);
    }

    async function buscarDireccion() {
        const input = document.getElementById('dest');
        const btn = document.getElementById('btn-add');
        const query = input.value.trim();
        
        if (!query) return;

        // Feedback visual de carga
        btn.innerText = "BUSCANDO...";
        btn.disabled = true;

        try {
            const url = `https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(query + ", Montevideo, Uruguay")}.json?access_token=${ACCESS_TOKEN}&limit=1`;
            const resp = await fetch(url);
            const data = await resp.json();

            if (data.features && data.features.length > 0) {
                const feat = data.features[0];
                paradas.push({
                    id: Date.now(),
                    nombre: query.toUpperCase(),
                    coords: feat.center
                });
                
                input.value = "";
                document.getElementById('stats-container').style.display = 'block';
                document.getElementById('nav-btns').style.display = 'grid';
                actualizarRuta();
            } else {
                alert("No encontr√© esa direcci√≥n exacta.");
            }
        } catch (e) {
            alert("Error de conexi√≥n con el mapa.");
        } finally {
            btn.innerText = "+ A√ëADIR ENTREGA";
            btn.disabled = false;
        }
    }

    async function actualizarRuta() {
        renderLista();
        
        // Limpiar marcadores anteriores
        markers.forEach(m => m.remove());
        
        // Crear nuevos marcadores
        markers = paradas.map((p, i) => {
            return new mapboxgl.Marker({ color: '#58a6ff' })
                .setLngLat(p.coords)
                .addTo(map);
        });

        const puntos = [UPRINT_LOCATION, ...paradas.map(p => p.coords)];
        const coordString = puntos.map(c => c.join(',')).join(';');
        
        try {
            const res = await fetch(`https://api.mapbox.com/directions/v5/mapbox/driving/${coordString}?geometries=geojson&access_token=${ACCESS_TOKEN}`);
            const d = await res.json();

            if (d.routes && d.routes[0]) {
                const route = d.routes[0];
                const dist = (route.distance / 1000).toFixed(1);
                
                document.getElementById('km-text').innerText = `${dist} KM`;
                document.getElementById('price-text').innerText = `$${Math.round(90 + (dist * 14))}`;
                
                dibujarLinea(route.geometry);
                
                const bounds = new mapboxgl.LngLatBounds();
                puntos.forEach(p => bounds.extend(p));
                map.fitBounds(bounds, { padding: 50 });
            }
        } catch(e) { console.error("Error trazando ruta"); }
    }

    function dibujarLinea(geojson) {
        if (map.getSource('route')) {
            map.getSource('route').setData(geojson);
        } else {
            map.addSource('route', { type: 'geojson', data: geojson });
            map.addLayer({
                id: 'route', type: 'line', source: 'route',
                layout: { 'line-join': 'round', 'line-cap': 'round' },
                paint: { 'line-color': '#58a6ff', 'line-width': 4 }
            });
        }
    }

    function renderLista() {
        document.getElementById('lista-paradas').innerHTML = paradas.map((p, i) => `
            <div class="stop-item">
                <span><b>${i+1}.</b> ${p.nombre}</span>
                <button onclick="eliminar(${p.id})" style="background:none; border:none; color:red; font-weight:bold;">‚úñ</button>
            </div>
        `).join('');
    }

    function eliminar(id) {
        paradas = paradas.filter(p => p.id !== id);
        actualizarRuta();
    }

    function optimizarRuta() {
        if (paradas.length < 2) return;
        let opt = [], copia = [...paradas], actual = UPRINT_LOCATION;
        while (copia.length > 0) {
            let idx = 0, min = Infinity;
            copia.forEach((p, i) => {
                let d = Math.sqrt((actual[0]-p.coords[0])**2 + (actual[1]-p.coords[1])**2);
                if (d < min) { min = d; idx = i; }
            });
            actual = copia[idx].coords;
            opt.push(copia.splice(idx, 1)[0]);
        }
        paradas = opt;
        actualizarRuta();
    }

    function abrirWaze() {
        if (!paradas.length) return;
        window.open(`https://www.waze.com/ul?ll=${paradas[0].coords[1]},${paradas[0].coords[0]}&navigate=yes`);
    }

    // Ejecutar inicio
    init();
</script>
</body>
</html>







