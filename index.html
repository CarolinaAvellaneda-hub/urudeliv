<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>UruDeliv Pro - Log√≠stica</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        :root { --bg: #0d1117; --card: #161b22; --accent: #58a6ff; --text: #c9d1d9; --success: #238636; --danger: #da3633; }
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); color: var(--text); padding: 10px; }
        .card { background: var(--card); border: 1px solid #30363d; border-radius: 12px; padding: 15px; margin-bottom: 12px; }
        .btn { width: 100%; padding: 12px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; font-size: 14px; transition: 0.2s; }
        .btn-uprint { background: #f59e0b; color: #000; margin-bottom: 15px; border: 2px solid #fff; }
        .btn-calc { background: var(--success); color: white; margin-top: 5px; }
        input { width: 100%; padding: 12px; background: #010409; border: 1px solid #30363d; color: white; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        #map { height: 250px; border-radius: 10px; margin: 15px 0; display: none; border: 1px solid #30363d; }
        .stop-item { display: flex; justify-content: space-between; align-items: center; background: #21262d; padding: 10px; border-radius: 6px; margin-top: 8px; border-left: 4px solid var(--accent); }
        .btn-del { background: var(--danger); color: white; padding: 5px 10px; width: auto; font-size: 12px; }
        .waze-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        .btn-waze { background: #33ccff; color: #000; }
        .badge { background: var(--accent); color: #000; padding: 2px 8px; border-radius: 10px; font-size: 12px; font-weight: bold; }
    </style>
</head>
<body>

    <div class="card">
        <button class="btn btn-uprint" onclick="activarUprint()">üìç ACTIVAR ORIGEN: UPRINT</button>
        
        <label style="display:block; margin-bottom: 8px; font-size: 12px; color: #8b949e;">A√ëADIR DESTINOS DE ENTREGA:</label>
        <input type="text" id="dest" placeholder="Ej: Ceibal 1587" onkeypress="if(event.key==='Enter') agregarParada()">
        <button class="btn btn-calc" onclick="agregarParada()">+ A√ëADIR A LA RUTA</button>
    </div>

    <div id="contenedor-ruta" class="card" style="display:none">
        <h3 id="stats" style="text-align:center; color:var(--accent); margin: 5px 0;"></h3>
        <div id="lista-paradas"></div>
        
        <div id="map"></div>

        <div class="waze-grid">
            <button class="btn btn-waze" onclick="abrirWaze('uprint')">IR A UPRINT</button>
            <button class="btn btn-waze" onclick="abrirWaze('cliente')">PR√ìXIMO CLIENTE</button>
        </div>
        
        <button class="btn" style="background:#30363d; color:#c9d1d9; margin-top:15px" onclick="location.reload()">LIMPIAR TODO</button>
    </div>

<script>
    const GPS_UPRINT = { lat: -34.898835, lon: -56.173822, n: "UPRINT (Colonia 2095)" };
    let pSalida = null;
    let paradas = [];
    let mapa = null;
    let markers = [];

    function activarUprint() {
        pSalida = GPS_UPRINT;
        document.querySelector('.btn-uprint').style.background = "#238636";
        document.querySelector('.btn-uprint').style.color = "white";
        document.querySelector('.btn-uprint').innerText = "‚úÖ ORIGEN CONFIGURADO";
    }

    async function agregarParada() {
        const input = document.getElementById('dest');
        const direccion = input.value.trim();
        
        if(!pSalida) return alert("Primero activa el punto de origen (UPRINT)");
        if(!direccion) return alert("Escribe una direcci√≥n");

        try {
            const r = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(direccion + ", Montevideo, Uruguay")}&limit=1`);
            const data = await r.json();

            if(data[0]) {
                paradas.push({
                    lat: parseFloat(data[0].lat),
                    lon: parseFloat(data[0].lon),
                    n: direccion.toUpperCase()
                });
                input.value = "";
                actualizarApp();
            } else {
                alert("No se encontr√≥ la direcci√≥n. Intenta agregar el n√∫mero de puerta.");
            }
        } catch (e) {
            alert("Error de conexi√≥n. Intenta de nuevo.");
        }
    }

    function eliminarParada(index) {
        paradas.splice(index, 1);
        actualizarApp();
    }

    function actualizarApp() {
        const contenedor = document.getElementById('contenedor-ruta');
        if(paradas.length === 0) {
            contenedor.style.display = 'none';
            return;
        }
        contenedor.style.display = 'block';
        
        renderizarLista();
        calcularYMostrarStats();
        dibujarMapa();
    }

    function renderizarLista() {
        const lista = document.getElementById('lista-paradas');
        lista.innerHTML = paradas.map((p, i) => `
            <div class="stop-item">
                <span><span class="badge">${i+1}</span> ${p.n}</span>
                <button class="btn btn-del" onclick="eliminarParada(${i})">Borrar</button>
            </div>
        `).join('');
    }

    function calcularYMostrarStats() {
        let distTotal = 0;
        let actual = pSalida;

        paradas.forEach(p => {
            distTotal += calcularHaversine(actual, p);
            actual = p;
        });

        // Aplicamos factor de correcci√≥n de calle (20%) y tarifa
        const distReal = distTotal * 1.2;
        const precio = Math.round(90 + (distReal * 14));

        document.getElementById('stats').innerText = `${paradas.length} Env√≠os | ${distReal.toFixed(1)} km | $${precio}`;
    }

    function calcularHaversine(p1, p2) {
        const R = 6371;
        const dLat = (p2.lat - p1.lat) * Math.PI / 180;
        const dLon = (p2.lon - p1.lon) * Math.PI / 180;
        const a = Math.sin(dLat/2)**2 + Math.cos(p1.lat*Math.PI/180)*Math.cos(p2.lat*Math.PI/180)*Math.sin(dLon/2)**2;
        return R * 2 * Math.asin(Math.sqrt(a));
    }

    function dibujarMapa() {
        document.getElementById('map').style.display = 'block';
        if(mapa) mapa.remove();
        
        mapa = L.map('map', {zoomControl: false});
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(mapa);

        let puntos = [[pSalida.lat, pSalida.lon], ...paradas.map(p => [p.lat, p.lon])];
        
        puntos.forEach((p, i) => {
            const color = i === 0 ? 'orange' : 'blue';
            L.circleMarker(p, {color: color, radius: 8}).addTo(mapa)
             .bindPopup(i === 0 ? "ORIGEN" : "Parada " + i);
        });

        mapa.fitBounds(puntos, {padding: [30, 30]});
    }

    function abrirWaze(tipo) {
        let destino;
        if(tipo === 'uprint') {
            destino = pSalida;
        } else {
            if(paradas.length === 0) return alert("No hay paradas en la lista");
            destino = paradas[0]; // Navega a la siguiente parada pendiente
        }
        
        const url = `https://www.waze.com/ul?ll=${destino.lat},${destino.lon}&navigate=yes`;
        window.open(url, '_blank');
    }
</script>
</body>
</html>

