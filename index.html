<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>UruDeliv Fix v4.0</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        :root { --bg: #0a0c10; --card: #161b22; --accent: #2f81f7; --text: #c9d1d9; }
        body { margin: 0; font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        .header { padding: 15px; text-align: center; background: var(--card); border-bottom: 1px solid #30363d; font-weight: bold; }
        .content { flex: 1; overflow-y: auto; padding: 15px; padding-bottom: 100px; }
        .card { background: var(--card); border-radius: 12px; padding: 15px; border: 1px solid #30363d; margin-bottom: 15px; }
        input { width: 100%; padding: 12px; margin: 8px 0; background: #0d1117; border: 1px solid #30363d; border-radius: 8px; color: white; box-sizing: border-box; }
        .btn { width: 100%; padding: 14px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 5px; }
        .btn-blue { background: var(--accent); color: white; }
        .btn-uprint { background: transparent; border: 2px solid #f59e0b; color: #f59e0b; margin-bottom: 15px; font-size: 16px; }
        #map { height: 250px; border-radius: 12px; margin-top: 10px; display: none; border: 1px solid #30363d; }
        .waze-box { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
        .btn-waze { background: #33ccff; color: #000; }
    </style>
</head>
<body>

<div class="header">UruDeliv PRO <span style="color:var(--accent)">FIXED</span></div>

<div class="content">
    <div class="card">
        <p style="margin:0 0 10px 0; font-size: 12px; color: #8b949e;">PASO 1: TOCAR EL LOCAL</p>
        <button class="btn btn-uprint" onclick="fijarUprint()">üìç USAR UPRINT (Colonia 2095)</button>
        
        <p style="margin:10px 0; font-size: 12px; color: #8b949e;">PASO 2: DIRECCI√ìN CLIENTE</p>
        <input type="text" id="client" placeholder="Ej: Ceibal 1587">
        <button class="btn btn-blue" onclick="calcularTotal()">CALCULAR RUTA REAL</button>
    </div>

    <div id="result" class="card" style="display:none;">
        <div id="map"></div>
        <h2 id="stats" style="text-align:center; color:#4ade80; margin:15px 0;"></h2>
        <div class="waze-box">
            <button class="btn btn-waze" onclick="navegar('s')">WAZE TIENDA</button>
            <button class="btn btn-waze" onclick="navegar('c')">WAZE CLIENTE</button>
        </div>
        <button class="btn" style="background:#30363d; color:white; margin-top:10px;" onclick="location.reload()">NUEVO PEDIDO</button>
    </div>
</div>

<script>
    // COORDENADAS SATELITALES VERIFICADAS (Colonia y Joaquin Requena)
    const UPRINT_GPS = { lat: -34.89882, lon: -56.17382, n: "Uprint (Colonia 2095)" };
    
    let origen = null;
    let destino = null;
    let map = null;

    function fijarUprint() {
        origen = UPRINT_GPS;
        alert("‚úÖ UPRINT SELECCIONADO\nAhora ingresa el destino.");
    }

    async function calcularTotal() {
        const dVal = document.getElementById('client').value;
        if (!origen) return alert("¬°Toca el bot√≥n naranja de UPRINT primero!");
        if (!dVal) return alert("Escribe la direcci√≥n del cliente");

        // Buscar cliente
        try {
            const resp = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(dVal + ", Montevideo, Uruguay")}&limit=1`);
            const data = await resp.json();
            
            if (data.length > 0) {
                destino = { lat: parseFloat(data[0].lat), lon: parseFloat(data[0].lon), n: dVal };
                
                // C√°lculo de KM
                const R = 6371;
                const dLat = (destino.lat - origen.lat) * Math.PI / 180;
                const dLon = (destino.lon - origen.lon) * Math.PI / 180;
                const a = Math.sin(dLat/2)**2 + Math.cos(origen.lat*Math.PI/180)*Math.cos(destino.lat*Math.PI/180)*Math.sin(dLon/2)**2;
                const dist = (R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a))).toFixed(1);

                // Mostrar resultados
                document.getElementById('stats').innerText = `${dist} KM | $${Math.round(90 + dist*12)}`;
                document.getElementById('result').style.display = 'block';
                document.getElementById('map').style.display = 'block';
                
                dibujarMapa();
            } else {
                alert("No encontr√© esa calle. Prueba con las esquinas.");
            }
        } catch (e) { alert("Error de red"); }
    }

    function dibujarMapa() {
        if (map) map.remove();
        map = L.map('map', {zoomControl: false});
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);
        L.marker([origen.lat, origen.lon]).addTo(map);
        L.marker([destino.lat, destino.lon]).addTo(map);
        map.fitBounds([[origen.lat, origen.lon], [destino.lat, destino.lon]], {padding:[30,30]});
    }

    function navegar(tipo) {
        const p = (tipo === 's') ? origen : destino;
        // El secreto: Si es el cliente, que Waze lo busque por texto para ser m√°s exacto.
        if (tipo === 'c') {
            window.open(`https://waze.com/ul?q=${encodeURIComponent(p.n + ", Montevideo, Uruguay")}&navigate=yes`);
        } else {
            window.open(`https://waze.com/ul?ll=${p.lat},${p.lon}&navigate=yes`);
        }
    }
</script>
</body>
</html>
