<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>UruDeliv TOTAL FIX</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        :root { --bg: #0d1117; --card: #161b22; --accent: #58a6ff; --text: #c9d1d9; }
        body { margin: 0; font-family: sans-serif; background: var(--bg); color: var(--text); padding: 15px; }
        .card { background: var(--card); border: 1px solid #30363d; border-radius: 12px; padding: 20px; margin-bottom: 15px; }
        .btn { width: 100%; padding: 15px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; margin-bottom: 10px; font-size: 16px; }
        .btn-uprint { background: #f59e0b; color: #000; border: 2px solid #fff; }
        .btn-calc { background: #238636; color: white; }
        input { width: 100%; padding: 15px; background: #010409; border: 1px solid #30363d; color: white; border-radius: 8px; box-sizing: border-box; margin-bottom: 15px; }
        #map { height: 200px; border-radius: 10px; margin: 15px 0; display: none; }
        .waze-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .btn-waze { background: #33ccff; color: #000; }
    </style>
</head>
<body>

    <div class="card">
        <h3 style="margin-top:0">1. ACTIVAR LOCAL</h3>
        <button class="btn btn-uprint" onclick="activarUprint()">üìç UPRINT (Colonia 2095)</button>
        
        <h3>2. DESTINO</h3>
        <input type="text" id="dest" placeholder="Ej: Ceibal 1587">
        <button class="btn btn-calc" onclick="generarRuta()">CALCULAR PRECIO EXACTO</button>
    </div>

    <div id="resultado" class="card" style="display:none">
        <div id="map"></div>
        <h2 id="stats" style="text-align:center; color:#58a6ff"></h2>
        <div class="waze-grid">
            <button class="btn btn-waze" onclick="waze('s')">WAZE TIENDA</button>
            <button class="btn btn-waze" onclick="waze('c')">WAZE CLIENTE</button>
        </div>
        <button class="btn" style="background:#444; color:white" onclick="location.reload()">BORRAR TODO</button>
    </div>

<script>
    // ESTAS COORDENADAS SON EL CENTRO EXACTO DE UPRINT EN COLONIA 2095
    const GPS_UPRINT = { lat: -34.898835, lon: -56.173822 };
    
    let pSalida = null;
    let pLlegada = null;
    let mapa = null;

    function activarUprint() {
        pSalida = GPS_UPRINT;
        alert("‚úÖ UPRINT CONFIGURADO EN COLONIA 2095");
    }

    async function generarRuta() {
        const d = document.getElementById('dest').value;
        if(!pSalida) return alert("Primero toca el bot√≥n de UPRINT");
        if(!d) return alert("Escribe el destino");

        const r = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(d + ", Montevideo, Uruguay")}&limit=1`);
        const data = await r.json();

        if(data[0]) {
            pLlegada = { lat: parseFloat(data[0].lat), lon: parseFloat(data[0].lon), n: d };
            
            // Distancia (Haversine)
            const R = 6371;
            const dLat = (pLlegada.lat - pSalida.lat) * Math.PI / 180;
            const dLon = (pLlegada.lon - pSalida.lon) * Math.PI / 180;
            const a = Math.sin(dLat/2)**2 + Math.cos(pSalida.lat*Math.PI/180)*Math.cos(pLlegada.lat*Math.PI/180)*Math.sin(dLon/2)**2;
            const dist = (R * 2 * Math.asin(Math.sqrt(a))).toFixed(1);

            document.getElementById('stats').innerText = `${dist} KM | $${Math.round(90 + dist*14)}`;
            document.getElementById('resultado').style.display = 'block';
            document.getElementById('map').style.display = 'block';

            if(mapa) mapa.remove();
            mapa = L.map('map', {zoomControl: false});
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(mapa);
            L.marker([pSalida.lat, pSalida.lon]).addTo(mapa);
            L.marker([pLlegada.lat, pLlegada.lon]).addTo(mapa);
            mapa.fitBounds([[pSalida.lat, pSalida.lon], [pLlegada.lat, pLlegada.lon]], {padding:[20,20]});
        } else {
            alert("Direcci√≥n no encontrada");
        }
    }

    function waze(tipo) {
        if(tipo === 's') {
            // FORMATO DE COORDENADA PURA PARA WAZE (SIN BUSCADOR)
            window.open(`waze://?ll=${pSalida.lat},${pSalida.lon}&navigate=yes`);
            // Respaldo por si no abre la app
            setTimeout(() => {
                window.open(`https://www.waze.com/ul?ll=${pSalida.lat},${pSalida.lon}&navigate=yes`);
            }, 500);
        } else {
            window.open(`https://www.waze.com/ul?q=${encodeURIComponent(pLlegada.n + ", Montevideo, Uruguay")}&navigate=yes`);
        }
    }
</script>
</body>
</html>
