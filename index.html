<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>UruDeliv Pro - v3.5</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        :root { --bg: #05070a; --card: #12151c; --accent: #2979ff; --text: #f0f2f5; --dim: #8b949e; --nav-h: 85px; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; font-family: sans-serif; background: var(--bg); color: var(--text); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        .header { padding: 15px 20px; font-size: 20px; font-weight: 800; background: var(--card); border-bottom: 1px solid #21262d; flex-shrink: 0; }
        .main-container { flex: 1; position: relative; overflow: hidden; }
        .view { display: none; height: 100%; width: 100%; padding: 20px; overflow-y: auto; padding-bottom: var(--nav-h); }
        .view.active { display: block; }
        #v-mapa { padding: 0; }
        #map { height: 100%; width: 100%; background: var(--bg); }
        .card { background: var(--card); border-radius: 16px; padding: 20px; border: 1px solid #30363d; margin-bottom: 20px; }
        h3 { margin-top: 0; font-size: 11px; text-transform: uppercase; color: var(--dim); letter-spacing: 1px; }
        input { width: 100%; padding: 16px; background: #0d1117; border: 1px solid #30363d; border-radius: 12px; color: white; font-size: 16px; margin-bottom: 10px; outline: none; }
        input:focus { border-color: var(--accent); }
        .btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .btn { width: 100%; padding: 16px; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; transition: 0.2s; font-size: 13px; }
        .btn-blue { background: var(--accent); color: white; }
        .btn-orange { background: #ff9800; color: white; }
        .btn-green { background: #238636; color: white; }
        .btn-finish { background: #f44336; color: white; width: 100%; }
        .nav-bar { position: fixed; bottom: 0; left: 0; right: 0; height: var(--nav-h); background: var(--card); display: flex; border-top: 1px solid #21262d; padding-bottom: env(safe-area-inset-bottom); z-index: 1000; }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--dim); font-size: 11px; }
        .nav-item.active { color: var(--accent); font-weight: bold; }
        .nav-icon { font-size: 24px; margin-bottom: 2px; }
        .loading-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 2000; color: white; align-items: center; justify-content: center; text-align: center; }
    </style>
</head>
<body>

<div id="loader" class="loading-overlay"><div>üìç Verificando mapa de Montevideo...<br><small>Sincronizando coordenadas exactas</small></div></div>
<div class="header">UruDeliv <span style="color:var(--accent)">PRO</span></div>

<div class="main-container">
    <div id="v-pedidos" class="view active">
        <div class="card">
            <h3>üìç Nuevo Reparto</h3>
            <input type="text" id="store" placeholder="Local (Ej: Uprint, Farmashop)">
            <input type="text" id="client" placeholder="Direcci√≥n Cliente">
            <button class="btn btn-blue" onclick="iniciarLogistica()">BUSCAR RUTA</button>
        </div>
        
        <div id="active-trip" class="card" style="display:none; border-left: 5px solid #2979ff;">
            <h4 id="trip-info" style="margin:0; color:var(--accent); font-size: 14px;"></h4>
            <p id="trip-cost" style="font-weight:bold; font-size:18px; margin: 10px 0; color: #4ade80;"></p>
            <div class="btn-group">
                <button class="btn btn-orange" onclick="abrirWaze('store')">üõí IR A RETIRO</button>
                <button class="btn btn-green" onclick="abrirWaze('client')">üéÅ IR A ENTREGA</button>
            </div>
            <button class="btn btn-finish" onclick="finalizarEntrega()">MARCAR ENTREGADO</button>
        </div>
    </div>

    <div id="v-mapa" class="view"><div id="map"></div></div>

    <div id="v-balance" class="view">
        <div class="card"><div style="height:150px"><canvas id="chart"></canvas></div></div>
        <div class="card"><h3>Historial de Ganancias</h3><div id="historial"></div></div>
    </div>
</div>

<div class="nav-bar">
    <div class="nav-item active" id="n-pedidos" onclick="show('pedidos')"><span class="nav-icon">üìã</span>Pedidos</div>
    <div class="nav-item" id="n-mapa" onclick="show('mapa')"><span class="nav-icon">üìç</span>Mapa</div>
    <div class="nav-item" id="n-balance" onclick="show('balance')"><span class="nav-icon">üìä</span>Balance</div>
</div>

<script>
    let db = JSON.parse(localStorage.getItem('uru_v3_5')) || [];
    let map, userMarker, storeMarker, clientMarker;
    let currentTrip = null;

    // BASE DE DATOS DE LOCALES FIJOS (Precisi√≥n 100%)
    const DB_LOCALES = {
        "uprint": { lat: -34.8988, lon: -56.1738, display: "Uprint (Colonia 2095)" },
        "uprint colonia": { lat: -34.8988, lon: -56.1738, display: "Uprint (Colonia 2095)" }
    };

    function show(v) {
        document.querySelectorAll('.view, .nav-item').forEach(e => e.classList.remove('active'));
        document.getElementById('v-'+v).classList.add('active');
        document.getElementById('n-'+v).classList.add('active');
        if(v === 'mapa') { setTimeout(() => { if(!map) initMap(); map.invalidateSize(); }, 200); }
        if(v === 'balance') renderBalance();
    }

    function initMap() {
        map = L.map('map', { zoomControl: false }).setView([-34.9011, -56.1645], 13);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);
        navigator.geolocation.watchPosition(p => {
            const pos = [p.coords.latitude, p.coords.longitude];
            if (!userMarker) userMarker = L.circleMarker(pos, {radius: 7, color: '#fff', weight: 2, fillColor: '#2979ff', fillOpacity: 1}).addTo(map);
            else userMarker.setLatLng(pos);
        });
    }

    async function buscarGPS(query) {
        const q = query.toLowerCase().trim();
        if(DB_LOCALES[q]) return DB_LOCALES[q]; // Si est√° en nuestra DB, usarlo directo

        try {
            const r = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query + ", Montevideo, Uruguay")}&limit=1`);
            const d = await r.json();
            if(d.length > 0) {
                return { lat: parseFloat(d[0].lat), lon: parseFloat(d[0].lon), display: d[0].display_name.split(',')[0] };
            }
            return null;
        } catch(e) { return null; }
    }

    function calcularDistancia(p1, p2) {
        const R = 6371;
        const dLat = (p2.lat-p1.lat)*Math.PI/180;
        const dLon = (p2.lon-p1.lon)*Math.PI/180;
        const a = Math.sin(dLat/2)**2 + Math.cos(p1.lat*Math.PI/180)*Math.cos(p2.lat*Math.PI/180)*Math.sin(dLon/2)**2;
        return (R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a))).toFixed(1);
    }

    async function iniciarLogistica() {
        const s = document.getElementById('store').value;
        const c = document.getElementById('client').value;
        if(!s || !c) return alert("Ingresa local y destino");

        document.getElementById('loader').style.display = 'flex';
        const pS = await buscarGPS(s);
        const pC = await buscarGPS(c);
        document.getElementById('loader').style.display = 'none';

        if(!pS || !pC) return alert("No se encontr√≥ la ubicaci√≥n. Prueba con 'Calle y Calle'.");

        const km = calcularDistancia(pS, pC);
        // Tarifa fija para que no var√≠e: $85 base + $8.5 por KM
        const total = Math.round(85 + (km * 8.5));

        currentTrip = { s: pS, c: pC, km: km, total: total };

        if(!map) initMap();
        if(storeMarker) map.removeLayer(storeMarker);
        if(clientMarker) map.removeLayer(clientMarker);

        storeMarker = L.marker([pS.lat, pS.lon]).addTo(map).bindPopup("RETIRO: " + pS.display);
        clientMarker = L.marker([pC.lat, pC.lon]).addTo(map).bindPopup("ENTREGA: " + pC.display);
        
        document.getElementById('trip-info').innerText = `${pS.display} ‚ûî ${pC.display}`;
        document.getElementById('trip-cost').innerText = `${km} km | $${total}`;
        document.getElementById('active-trip').style.display = 'block';
        show('mapa');
        map.fitBounds([[pS.lat, pS.lon], [pC.lat, pC.lon]], {padding: [50,50]});
    }

    function abrirWaze(tipo) {
        const p = tipo === 'store' ? currentTrip.s : currentTrip.c;
        window.open(`https://waze.com/ul?ll=${p.lat},${p.lon}&navigate=yes`);
    }

    function finalizarEntrega() {
        db.unshift({ name: currentTrip.c.display, km: currentTrip.km, total: currentTrip.total, dia: new Date().toLocaleDateString('es-ES', {weekday: 'short'}) });
        localStorage.setItem('uru_v3_5', JSON.stringify(db));
        document.getElementById('active-trip').style.display = 'none';
        document.getElementById('store').value = "";
        document.getElementById('client').value = "";
        show('balance');
    }

    function renderBalance() {
        const h = document.getElementById('historial');
        h.innerHTML = db.slice(0,10).map(p => `
            <div style="display:flex; justify-content:space-between; padding:12px 0; border-bottom:1px solid #21262d;">
                <span style="font-size:13px;">${p.name} <br><small style="color:var(--dim)">${p.km} km</small></span>
                <b style="color:#4ade80">$${p.total}</b>
            </div>`).join('');
            
        // Renderizar gr√°fico simple
        const ctx = document.getElementById('chart').getContext('2d');
        if(window.myChart) window.myChart.destroy();
        const labels = ['lun', 'mar', 'mi√©', 'jue', 'vie', 's√°b', 'dom'];
        const data = labels.map(l => db.filter(x => x.dia.includes(l)).reduce((a,b) => a + b.total, 0));
        window.myChart = new Chart(ctx, {
            type: 'bar',
            data: { labels, datasets: [{ data, backgroundColor: '#2979ff', borderRadius: 5 }] },
            options: { plugins: { legend: {display: false} }, scales: { y: { grid: {color: '#21262d'}, ticks: {color: '#8b949e'} }, x: { grid: {display: false}, ticks: {color: '#8b949e'} } } }
        });
    }
</script>
</body>
</html>


